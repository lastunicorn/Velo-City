// VeloCity
// Copyright (C) 2022-2023 Dust in the Wind
// 
// This program is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
// 
// This program is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
// 
// You should have received a copy of the GNU General Public License
// along with this program.  If not, see <http://www.gnu.org/licenses/>.

using DustInTheWind.VeloCity.Domain;
using DustInTheWind.VeloCity.JsonFiles.JsonFileModel;
using DustInTheWind.VeloCity.Ports.DataAccess;
using FluentAssertions;

namespace DustInTheWind.VeloCity.Tests.Integration.DataAccess.JsonFiles.JsonDatabaseFileTests;

public class OpenTests
{
    [Fact]
    public void HavingMissingFile_WhenOpened_ThenThrows()
    {
        JsonDatabaseFile jsonDatabaseFile = new(@"TestData\DataAccess.JsonFiles\JsonDatabaseFileTests\db-open.nonexistent.json");

        Action action = () =>
        {
            jsonDatabaseFile.Open();
        };

        action.Should().Throw<DatabaseNotFoundException>();
    }

    [Fact]
    public void HavingEmptyFile_WhenOpened()
    {
        JsonDatabaseFile jsonDatabaseFile = new(@"TestData\DataAccess.JsonFiles\JsonDatabaseFileTests\db-open.empty.json");
        jsonDatabaseFile.Open();

        jsonDatabaseFile.Document.DatabaseInfo.Should().BeNull();
        jsonDatabaseFile.Document.Sprints.Should().BeNull();
        jsonDatabaseFile.Document.TeamMembers.Should().BeNull();
        jsonDatabaseFile.Document.OfficialHolidays.Should().BeNull();
    }

    [Fact]
    public void HavingFileWithDatabaseInfo_WhenOpened()
    {
        JsonDatabaseFile jsonDatabaseFile = new(@"TestData\DataAccess.JsonFiles\JsonDatabaseFileTests\db-open.database-info.json");
        jsonDatabaseFile.Open();

        Version expectedVersion = new(2, 0, 0);
        jsonDatabaseFile.Document.DatabaseInfo.DatabaseVersion.Should().Be(expectedVersion);
    }

    [Fact]
    public void HavingFileWithOneSprint_WhenOpened()
    {
        JsonDatabaseFile jsonDatabaseFile = new(@"TestData\DataAccess.JsonFiles\JsonDatabaseFileTests\db-open.one-sprint.json");
        jsonDatabaseFile.Open();

        jsonDatabaseFile.Document.Sprints.Should().HaveCount(1);
        jsonDatabaseFile.Document.Sprints[0].Id.Should().Be(5);
        jsonDatabaseFile.Document.Sprints[0].Number.Should().Be(7);
        jsonDatabaseFile.Document.Sprints[0].Name.Should().Be("Dummy Name");
        jsonDatabaseFile.Document.Sprints[0].StartDate.Should().Be(new DateTime(2022, 02, 21));
        jsonDatabaseFile.Document.Sprints[0].EndDate.Should().Be(new DateTime(2022, 03, 06));
        jsonDatabaseFile.Document.Sprints[0].Goal.Should().Be("The goal of the sprint");
        jsonDatabaseFile.Document.Sprints[0].CommitmentStoryPoints.Should().Be(27);
        jsonDatabaseFile.Document.Sprints[0].ActualStoryPoints.Should().Be(24);
        jsonDatabaseFile.Document.Sprints[0].State.Should().Be(JSprintState.Closed);
        jsonDatabaseFile.Document.Sprints[0].Comments.Should().Be("some comments");
    }

    [Fact]
    public void HavingFileWithOneTeamMember_WhenOpened()
    {
        JsonDatabaseFile jsonDatabaseFile = new(@"TestData\DataAccess.JsonFiles\JsonDatabaseFileTests\db-open.one-team-member.json");
        jsonDatabaseFile.Open();

        jsonDatabaseFile.Document.TeamMembers.Should().HaveCount(1);
        jsonDatabaseFile.Document.TeamMembers[0].Id.Should().Be(7);
        jsonDatabaseFile.Document.TeamMembers[0].FirstName.Should().Be("Laura");
        jsonDatabaseFile.Document.TeamMembers[0].MiddleName.Should().Be("Allison");
        jsonDatabaseFile.Document.TeamMembers[0].LastName.Should().Be("Amberson");
        jsonDatabaseFile.Document.TeamMembers[0].Nickname.Should().Be("Alli");
        jsonDatabaseFile.Document.TeamMembers[0].Comments.Should().Be("This is the team member");

        jsonDatabaseFile.Document.TeamMembers[0].Employments[0].StartDate.Should().Be(new DateTime(2022, 02, 21));
        jsonDatabaseFile.Document.TeamMembers[0].Employments[0].EndDate.Should().Be(new DateTime(2027, 01, 25));
        jsonDatabaseFile.Document.TeamMembers[0].Employments[0].HoursPerDay.Should().Be((HoursValue)4);
        jsonDatabaseFile.Document.TeamMembers[0].Employments[0].WeekDays.Should().Equal(JDayOfWeek.Tuesday, JDayOfWeek.Wednesday, JDayOfWeek.Thursday, JDayOfWeek.Friday);
        jsonDatabaseFile.Document.TeamMembers[0].Employments[0].Country.Should().Be("RO");

        jsonDatabaseFile.Document.TeamMembers[0].VacationDays[0].Recurrence.Should().Be(JVacationRecurrence.Once);
        jsonDatabaseFile.Document.TeamMembers[0].VacationDays[0].Date.Should().Be(new DateTime(2022, 01, 20));
        jsonDatabaseFile.Document.TeamMembers[0].VacationDays[0].Comments.Should().Be("first vacation");

        jsonDatabaseFile.Document.TeamMembers[0].VacationDays[1].StartDate.Should().Be(new DateTime(2022, 03, 28));
        jsonDatabaseFile.Document.TeamMembers[0].VacationDays[1].EndDate.Should().Be(new DateTime(2022, 03, 31));
        jsonDatabaseFile.Document.TeamMembers[0].VacationDays[1].Comments.Should().Be("daily one");
    }
}